\chapter{Querying the environment}

\label{chap-environment-querying}

In this chapter, we describe classes and functions that are used by
the compiler to query the environment concerning information about
program elements that the compiler needs in order to determine how to
process those program elements.

When the compiler calls a generic query function, it passes two or
three arguments, depending on the function it calls.  The first
argument is called the \texttt{client}.  \sysname{} does not
specialize on this argument, but client code should define a standard
class and pass an instance of that class for this argument.  Client
code can then define auxiliary methods that specialize to this class
on the query generic functions.  The second argument is the
environment concerned by the query.  Client code must supply methods
on these functions, specialized to its particular representation of
its global environments.  If the client does not have an explicit
representation of its global environment (as is usually the case), it
must nevertheless define a dummy standard class to specialize on.
\sysname{} provides methods on the query functions, specialized to its
representation of \emph{lexical} environments.  Client code that wants
to use a different representation of lexical environments than the one
provided by \sysname{} must also provide methods specialized to its
lexical environment classes.

These methods should return instances of the classes described in this
chapter.  Any such instance contains all available information about
some program element in that particular environment.  This information
must typically be assembled from different parts of the environment.
For that reason, client code typically creates a new instance whenever
a query function is called, rather than attempting to store such
instances in the environment.  If any of these client-supplied methods
fails to accomplish its task, it should return \texttt{nil}.

Client code is free to define subclasses of the classes described
here, for instance in order to represent implementation-specific
information about the program elements.  Client code would then
typically also provide auxiliary methods or overriding primary methods
on the compilation functions that handle these classes.

\section{Query functions}

\subsection{Variable information}

\Defgeneric {variable-info} {client environment symbol}

This function is called by the compiler whenever a symbol in a
\emph{variable} position is to be compiled.  If successful, it returns
an instance of one of the classes described below.

\Defcondition {no-variable-info}

This condition is signaled by \sysname{} when a client-supplied method
on the generic function \texttt{variable-info} returns \texttt{nil}.

\Defmethod {name} {(condition {\tt no-variable-info})}

This method returns the name of the variable for which no info was
available.

\subsection{Function information}

\Defgeneric {function-info} {client environment function-name}

This function is called by the compiler whenever a symbol in a
\emph{function} position is to be compiled or whenever a function name
is found in a context where it is known to refer to a function.  It
returns an instance of one of the classes described below.

\Defcondition {no-function-info}

This condition is signaled by \sysname{} when a client-supplied method
on the generic function \texttt{function-info} returns \texttt{nil}.

\Defmethod {name} {(condition {\tt no-function-info})}

This method returns the name of the function for which no info was
available.

\subsection{Block information}

\Defgeneric {block-info} {client environment symbol}

\Defcondition {no-block-info}

This condition is signaled by \sysname{} when a client-supplied method
on the generic function \texttt{block-info} returns \texttt{nil}.

\Defmethod {name} {(condition {\tt no-block-info})}

This method returns the name of the block for which no info was
available.

\subsection{Tag information}

\Defgeneric {tag-info} {client environment tag}

\Defcondition {no-tag-info}

This condition is signaled by \sysname{} when a client-supplied method
on the generic function \texttt{tag-info} returns \texttt{nil}.

\Defmethod {name} {(condition {\tt no-tag-info})}

This method returns the name of the tag for which no info was
available.

\subsection{Class information}

\Defgeneric {class-info} {client environment class-name}

\Defcondition {no-class-info}

This condition is signaled by \sysname{} when a client-supplied method
on the generic function \texttt{class-info} returns \texttt{nil}.

\Defmethod {name} {(condition {\tt no-class-info})}

This method returns the name of the class for which no info was
available.

\subsection{Optimize information}

\Defgeneric {optimize-info} {client environment}

Client-supplied methods on this function must always return a valid
instance of the class \texttt{optimize-info}. Optimize info includes
information about optimize declarations.


\section{Mixin classes}

For maximum flexibility, each query class is the subclass of one or
more mixin classes, each one providing one single feature.  That
feature is represented as a slot with an initarg, a reader, an
initform, and a type.

\subsection{\texttt{name-mixin}}
\label{sec-name-mixin}

\Defclass {name-mixin}

This class is a superclass of query classes that require a name to
identify the information supplied by the class instances.

\Definitarg {:name}

\Defmethod {name} {(info {\tt name-mixin})}

Given an instance of the class \texttt{name-mixin}, this method
returns the name information, as supplied by the initarg
\texttt{:name}.

\subsection{\texttt{identity-mixin}}
\label{sec-identity-mixin}

\Defclass {identity-mixin}

This class is a superclass of query classes that require some kind of
identity to distinguish instances of the query class that have the
same name.

\Definitarg {:identity}

\Defmethod {identity} {(info {\tt identity-mixin})}

Given an instance of the class \texttt{identity-mixin}, this method
returns the identity information, as supplied by the initarg
\texttt{:identity}.

\subsection{\texttt{type-mixin}}
\label{sec-type-mixin}

\Defclass {type-mixin}

This class is a superclass of query classes that provide information
of entities that can have a type.

\Definitarg {:type}

If this initarg is not supplied, it defaults to \texttt{t}.

\Defmethod {type} {(info {\tt type-mixin})}

Given an instance of the class \texttt{type-mixin}, this method
returns the type information, as supplied by the initarg
\texttt{:type}.

\subsection{\texttt{ignore-mixin}}
\label{sec-ignore-mixin}

\Defclass {ignore-mixin}

This class is a superclass of query classes that provide information
of entities that can be declared \texttt{ignore} or \texttt{ignorable}.

\Definitarg {:ignore}

\Defmethod {ignore} {(info {\tt ignore-mixin})}

Given an instance of the class \texttt{ignore-mixin}, this method
returns the ignore information, as supplied by the initarg
\texttt{:ignore}.

\subsection{\texttt{dynamic-extent-mixin}}
\label{sec-dynamic-extent-mixin}

\Defclass {dynamic-extent-mixin}

This class is a superclass of query classes that provide information
of entities that can be declared \texttt{dynamic-extent}.

\Definitarg {:dynamic-extent}

\Defmethod {dynamic-extent} {(info {\tt dynamic-extent-mixin})}

Given an instance of the class \texttt{dynamic-extent-mixin}, this method
returns the dynamic-extent information, as supplied by the initarg
\texttt{:dynamic-extent}.

\subsection{\texttt{expansion-mixin}}
\label{sec-expansion-mixin}

This class is a superclass of query classes that provide information
of entities that can have an expansion.  In particular, it is a
superclass of the abstract class \texttt{symbol-macro-info}.

\Definitarg {:expansion}

\Defmethod {expansion} {(info {\tt expansion-mixin})}

Given an instance of the class \texttt{expansion-mixin}, this method
returns the expansion information, as supplied by the initarg
\texttt{:expansion}.

\subsection{\texttt{expander-mixin}}
\label{sec-expander-mixin}

This class is a superclass of query classes that provide information
of entities that can have an expander function.  In particular, it is
a superclass of the abstract class \texttt{macro-info}.

\Definitarg {:expander}

\Defmethod {expander} {(info {\tt expander-mixin})}

Given an instance of the class \texttt{expander-mixin}, this method
returns the expander information, as supplied by the initarg
\texttt{:expander}.

\subsection{\texttt{class-name-mixin}}
\label{sec-class-name-mixin}

This class is a superclass of query classes that provide information
of entities that can have a class-name.  In particular, it is a
superclass of the class \texttt{global-function-info}.

\Definitarg {:class-name}

\Defmethod {class-name} {(info {\tt class-name-mixin})}

Given an instance of the class \texttt{class-name-mixin}, this method
returns the class-name information, as supplied by the initarg
\texttt{:class-name}.

\subsection{\texttt{inline-mixin}}
\label{sec-inline-mixin}

This class is a superclass of query classes that provide information
of entities that can have inline information.  In particular, it is a
superclass of the class \texttt{authentic-function-info}.

\Definitarg {:inline}

Possible values for this initarg are \texttt{nil}, \texttt{inline},
and \texttt{notinline}, all symbols in the \texttt{common-lisp}
package.  The value \texttt{nil} means that no inline information has
been provided, and this is the default value if the initarg is omitted.

\Defmethod {inline} {(info {\tt inline-mixin})}

Given an instance of the class \texttt{inline-mixin}, this method
returns the inline information, as supplied by the initarg
\texttt{:inline}.

\subsection{\texttt{method-class-name-mixin}}
\label{sec-method-class-name-mixin}

This class is a superclass of query classes that provide information
of entities that can have method-class-name information.  In
particular, it is a superclass of the class
\texttt{generic-function-info}.

\Definitarg {:method-class-name}

The value of this initarg is a symbol naming a class to be used for
methods.  If this initarg is not given, it defaults to the symbol
\texttt{standard-method}.

\Defmethod {method-class-name} {(info {\tt method-class-name-mixin})}

Given an instance of the class \texttt{method-class-name-mixin}, this
method returns the method-class-name information, as supplied by the
initarg \texttt{:method-class-name}.

\subsection{\texttt{speed-mixin}}
\label{sec-speed-mixin}

This class is a superclass of query classes that provide information
of entities that can have speed information.  In particular, it is a
superclass of the class \texttt{optimize-info}.

\Definitarg {:speed}

The value of this initarg must be an integer between $0$ and $3$
inclusive.

\Defmethod {speed} {(info {\tt speed-mixin})}

Given an instance of the class \texttt{speed-mixin}, this method
returns the compilation-speed information, as supplied by the initarg
\texttt{:speed}.

\subsection{\texttt{compilation-speed-mixin}}
\label{sec-compilation-speed-mixin}

This class is a superclass of query classes that provide information
of entities that can have compilation-speed information.  In particular, it is a
superclass of the class \texttt{optimize-info}.

\Definitarg {:compilation-speed}

The value of this initarg must be an integer between $0$ and $3$
inclusive.

\Defmethod {compilation-speed} {(info {\tt compilation-speed-mixin})}

Given an instance of the class \texttt{compilation-speed-mixin}, this method
returns the compilation-compilation-speed information, as supplied by the initarg
\texttt{:compilation-speed}.

\subsection{\texttt{debug-mixin}}
\label{sec-debug-mixin}

This class is a superclass of query classes that provide information
of entities that can have debug information.  In particular, it is a
superclass of the class \texttt{optimize-info}.

\Definitarg {:debug}

The value of this initarg must be an integer between $0$ and $3$
inclusive.

\Defmethod {debug} {(info {\tt debug-mixin})}

Given an instance of the class \texttt{debug-mixin}, this method
returns the compilation-debug information, as supplied by the initarg
\texttt{:debug}.

\subsection{\texttt{space-mixin}}
\label{sec-space-mixin}

This class is a superclass of query classes that provide information
of entities that can have space information.  In particular, it is a
superclass of the class \texttt{optimize-info}.

\Definitarg {:space}

The value of this initarg must be an integer between $0$ and $3$
inclusive.

\Defmethod {space} {(info {\tt space-mixin})}

Given an instance of the class \texttt{space-mixin}, this method
returns the compilation-space information, as supplied by the initarg
\texttt{:space}.

\subsection{\texttt{safety-mixin}}
\label{sec-safety-mixin}

This class is a superclass of query classes that provide information
of entities that can have safety information.  In particular, it is a
superclass of the class \texttt{optimize-info}.

\Definitarg {:safety}

The value of this initarg must be an integer between $0$ and $3$
inclusive.

\Defmethod {safety} {(info {\tt safety-mixin})}

Given an instance of the class \texttt{safety-mixin}, this method
returns the compilation-safety information, as supplied by the initarg
\texttt{:safety}.

\subsection{\texttt{superclass-names-mixin}}
\label{sec-superclass-names-mixin}

This class is a superclass of query classes that provide information
of entities that can have superclass-names information.  In
particular, it is a superclass of the class \texttt{class-info}.

\Definitarg {:superclass-names}

The value of this initarg is a list of symbols naming a classes.  If
this initarg is not given, it defaults the empty list.  Only
explicitly mentioned superclass names should be provided.

\Defmethod {superclass-names} {(info {\tt superclass-names-mixin})}

Given an instance of the class \texttt{superclass-names-mixin}, this
method returns the superclass-names information, as supplied by the
initarg \texttt{:superclass-names}.

\subsection{\texttt{metaclass-name-mixin}}
\label{sec-metaclass-name-mixin}

This class is a superclass of query classes that provide information
of entities that can have metaclass-name information.  In
particular, it is a superclass of the class
\texttt{class-info}.

\Definitarg {:metaclass-name}

The value of this initarg is a symbol naming a class to be used as a
metaclasss.  If this initarg is not given, it defaults to the symbol
\texttt{standard-class}.

\Defmethod {metaclass-name} {(info {\tt metaclass-name-mixin})}

Given an instance of the class \texttt{metaclass-name-mixin}, this
metaclass returns the metaclass-name information, as supplied by the
initarg \texttt{:metaclass-name}.

\section{Abstract query classes}

\Defclass {variable-info}

This abstract class is the superclass of every query class returned by
a call to the generic function \texttt{variable-info}.  It is a
subclass of the class \texttt{name-mixin}.

\Defclass {authentic-variable-info}

This abstract class is a subclass of the classes
\texttt{variable-info} and \texttt{type-mixin}.

It is a superclass of the two instantiable classes
\texttt{lexical-variable-info} and
\texttt{special-variable-info}.

\Defclass {symbol-macro-info}

This abstract class is a subclass of the classes
\texttt{variable-info}, \texttt{type-mixin}, and
\texttt{expansion-mixin}.

It is a superclass of the two instantiable classes
\texttt{local-symbol-macro-info} and
\texttt{global-symbol-macro-info}.

\Defclass {function-info}

This abstract class is the superclass of every query class returned by
a call to the generic function \texttt{function-info}.  It is a
subclass of the class \texttt{name-mixin}.

\Defclass {authentic-function-info}

This abstract class is a subclass of the classes
\texttt{function-info} and \texttt{type-mixin}.

It is a superclass of the two instantiable classes
\texttt{local-function-info} and
\texttt{global-function-info}.

\Defclass {macro-info}

This abstract class is a subclass of the classes
\texttt{function-info} and \texttt{expander-mixin}.

It is a superclass of the two instantiable classes
\texttt{local-macro-info} and
\texttt{global-macro-info}.

\section{Instantiable classes}

\subsection{Variable information}

\Defclass {lexical-variable-info}

This class represents information about lexical variables.  An
instance of this class is returned by a call to \texttt{variable-info}
when it turns out that the symbol passed as an argument refers to a
lexical variable.

This class is a subclass of the classes
\texttt{authentic-variable-info} \texttt{identity-mixin},
\texttt{ignore-mixin}, and \texttt{dynamic-extent-mixin}.

\Defclass {special-variable-info}

This class represents information about special variables.   An
instance of this class is returned by a call to \texttt{variable-info}
when it turns out that the symbol passed as an argument refers to a
special variable.

This class is a subclass of the classes
\texttt{authentic-variable-info} and \texttt{global-p-mixin}.

\Defclass {constant-variable-info}

This class represents information about constant variables.   An
instance of this class is returned by a call to \texttt{variable-info}
when it turns out that the symbol passed as an argument refers to a
constant variable.

This class is a subclass of the classes \texttt{variable-info} and
\texttt{value-mixin}.

\Defclass {global-symbol-macro-info}

This class is a subclass of \texttt{symbol-macro-info}.  It is
returned by a call to \texttt{variable-information} when the name is
defined as a global symbol macro, as defined by
\texttt{define-symbol-macro}.

\Defclass {local-symbol-macro-info}

This class is a subclass of \texttt{symbol-macro-info} and
\texttt{ignore-mixin}.  It is returned by a call to
\texttt{variable-information} when the name is defined as a local
symbol macro, as defined by \texttt{symbol-macrolet}.

\subsection{Function information}

\Defclass {local-function-info}

This class represents information about local functions introduced by
\texttt{flet} or \texttt{labels}.  An instance of this class is
returned by a call to \texttt{function-info} when it turns out that
the function name passed as an argument refers to a local function.

This class is a subclass of \texttt{authentic-function-info},
\texttt{identity-mixin}, \texttt{ignore-mixin}, and \texttt{dynamic-extent-mixin}.

\Defclass {global-function-info}

This class represents information about global functions.  An instance
of this class is returned by a call to \texttt{function-info} when it
turns out that the function name passed as an argument refers to a
global function.

This class is a subclass of \texttt{authentic-function-info},
\texttt{compiler-macro-mixin}, and \texttt{class-name-mixin}.

\Defclass {generic-function-info}

This class is a subclass of \texttt{global-function-info} and
\texttt{method-class-name-mixin}.


\Defclass {local-macro-info}

This class represents information about local macros introduced by
\texttt{macrolet}.  An instance of this class is returned by a call to
\texttt{function-info} when it turns out that the function name passed
as an argument refers to a local macro.

This class is a subclass of \texttt{macro-info} and \texttt{ignore-mixin}.

\Defclass {global-macro-info}

This class represents information about global macros introduced by
\texttt{macrolet}.  An instance of this class is returned by a call to
\texttt{function-info} when it turns out that the function name passed
as an argument refers to a global macro.

This class is a subclass of \texttt{macro-info} and \texttt{compiler-macro-mixin}.

\Defclass {special-operator-info}

This class represents information about special operators.  An
instance of this class is returned by a call to \texttt{function-info}
when it turns out that the function name passed as an argument refers
to a specialoperator.

This class is a subclass of the class \texttt{function-info}.

\subsection{Block information}

\Defclass {block-info}

This class represents information about blocks introduced by
\texttt{block}.  An instance of this class is returned by a call to
\texttt{block-info} when the symbol passed as an argument refers to a
block.

This class is a subclass of the classes \texttt{name-mixin} and
\texttt{identity-mixin}.

\subsection{Tag information}

\Defclass {tag-info}

This class represents information about tags introduced by
\texttt{tagbody}.  An instance of this class is returned by a call to
\texttt{tag-info} when the name (which must be a symbol or an integer)
passed as an argument refers to a tag.

This class is a subclass of the classes \texttt{name-mixin} and
\texttt{identity-mixin}.

\subsection{Class information}

\Defclass {class-info}

This class represents information about a class introduced by
\texttt{defclass}.  An instance of this class is returned by a call to
\texttt{class-info} when the name (which must be a symbol)
passed as an argument refers to a class.

This class is a subclass of the classes \texttt{name-mixin},
\texttt{superclass-names-mixin},  and
\texttt{metaclass-name-mixin}.

\subsection{Optimization information}

\Defclass {optimize-info}

This class is a subclass of \texttt{speed-mixin},
\texttt{compilation-speed-mixin}, \texttt{debug-mixin},
\texttt{space-mixin}, and \texttt{safety-mixin}.
