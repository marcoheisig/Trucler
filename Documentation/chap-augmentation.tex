\chapter{Augmenting the environment}

\section{Creating new information instances}

In order to create a new information instance, \texttt{make-instance}
must be called, providing values for all the initialization arguments
corresponding to features that do not have any initialization forms.

\section{Low-level augmentation functions}

In this section, we describe basic functions for augmenting an
environment, given an old environment and an information instance.

{\footnotesize
\Defgeneric {augment-with-variable-information} {client environment information}
}

This function is used to create a new environment object from an
existing environment object and an instance of the class
\texttt{variable-information}.

\Defmethod {augment-with-variable-information}\\
           {client\\
            (environment {\tt environment})\\
            (information {\tt variable-information})}

This default method returns a new environment object which is like the
one passed as an argument, except that \textit{information}
will shadow any variable information with the same name.

\Defgeneric {augment-with-function-information}\\
            {client environment function-information}

This function is used to create a new environment object from an
existing environment object and an instance of the class
\texttt{function-information}.

\Defmethod {augment-with-function-information}\\
           {client\\
            (environment {\tt environment})\\
            (function-information {\tt function-information})}

This default method returns a new environment object which is like the
one passed as an argument, except that \textit{function-information}
will shadow any function information with the same name.

\Defgeneric {augment-with-block-information}\\
            {client environment block-information}

This function is used to create a new environment object from an
existing environment object and an instance of the class
\texttt{block-information}.

\Defmethod {augment-with-block-information}\\
           {client\\
            (environment {\tt environment})\\
            (block-information {\tt block-information})}

This default method returns a new environment object which is like the
one passed as an argument, except that \textit{block-information}
will shadow any block information with the same name.

\Defgeneric {augment-with-tag-information}\\
            {client environment tag-information}

This function is used to create a new environment object from an
existing environment object and an instance of the class
\texttt{tag-information}.

\Defmethod {augment-with-tag-information}\\
           {client\\
            (environment {\tt environment})\\
            (tag-information {\tt tag-information})}

This default method returns a new environment object which is like the
one passed as an argument, except that \textit{tag-information}
will shadow any tag information with the same name.

\Defgeneric {augment-with-optimize-information}\\
            {client environment optimize-information}

This function is used to create a new environment object from an
existing environment object and an instance of the class
\texttt{optimize-information}.

\Defmethod {augment-with-optimize-information}\\
           {client\\
            (environment {\tt environment})\\
            (optimize-information {\tt optimize-information})}

This default method returns a new environment object which is like the
one passed as an argument, except that \textit{optimize-information}
will shadow any previous optimize information.

\section{Merging information instances}

We use the term \emph{merging} to mean the creation of a new
information instance from an existing information instance plus some
additional information such as type or dynamic extent.

In this section, we describe generic functions that are provided for
this purpose.

\Defgeneric {merge-type} {client information type}

Given an instance of the class \texttt{information} and a
type descriptor, return a new instance that is just like
\textit{information} (including the class and the values of
all the slots), except that its type information has been updated
according to that of \textit{type}.

\Defmethod {merge-type}\\
           {client\\
            (information {\tt type-mixin})\\
            type}

This is the default method provided on \texttt{merge-type}
and it is specialized to \texttt{type-mixin}.

\Defgeneric {merge-ignore} {client information ignore}

Given an instance of the class \texttt{information} and one
of the symbols \texttt{cl:ignore} and \texttt{cl:ignorable},
return a new instance that is just like
\textit{information} (including the class and the values of
all the slots), except that its ignore information has been updated
according to that of \textit{ignore}.

\Defmethod {merge-ignore}\\
           {client\\
            (information {\tt ignore-mixin})\\
            ignore}

This is the default method provided on \texttt{merge-ignore}
and it is specialized to \texttt{ignore-mixin}.

\Defgeneric {merge-dynamic-extent} {client information}

Given an instance of the class \texttt{information}, return a
new instance that is just like \textit{information}
(including the class and the values of all the slots), except that its
dynamic-extent information has been updated so that it is \emph{true}.

{\footnotesize
\Defmethod {merge-dynamic-extent} {client (information {\tt dynamic-extent-mixin})}
}

This is the default method provided on
\texttt{merge-dynamic-extent} and it is specialized to
\texttt{dynamic-extent-mixin}.

\Defgeneric {merge-inline} {client information inline}

Given an instance of the class \texttt{information} and one
of the symbols \texttt{cl:inline} and \texttt{cl:notinline},
return a new instance that is just like
\textit{information} (including the class and the values of
all the slots), except that its inline information has been updated
according to that of \textit{inline}.

\Defmethod {merge-inline}\\
           {client\\
            (information {\tt inline-mixin})\\
            inline}

This is the default method provided on \texttt{merge-inline}
and it is specialized to \texttt{inline-mixin}.

\Defgeneric {merge-speed} {client information value}

Given an instance of the class \texttt{information} and an
integer between $0$ and $3$, return a new instance that is just like
\textit{information} (including the class and the values of
all the slots), except that its speed information has been updated
according to that of \textit{value}.

\Defmethod {merge-speed}\\
           {client\\
            (information {\tt speed-mixin})\\
            value}

This is the default method provided on \texttt{merge-speed} and it is
specialized to \texttt{speed-mixin}.

\Defgeneric {merge-compilation-speed} {client information value}

Given an instance of the class \texttt{information} and an
integer between $0$ and $3$, return a new instance that is just like
\textit{information} (including the class and the values of
all the slots), except that its compilation-speed information has been
updated according to that of \textit{value}.

\Defmethod {merge-compilation-speed}\\
           {client\\
            (information {\tt compilation-speed-mixin})\\
            value}

This is the default method provided on
\texttt{merge-compilation-speed} and it is specialized to
\texttt{compilation-speed-mixin}.

\Defgeneric {merge-debug} {client information value}

Given an instance of the class \texttt{information} and an
integer between $0$ and $3$, return a new instance that is just like
\textit{information} (including the class and the values of
all the slots), except that its debug information has been updated
according to that of \textit{value}.

\Defmethod {merge-debug}\\
           {client\\
            (information {\tt debug-mixin})\\
            value}

This is the default method provided on \texttt{merge-debug} and it is
specialized to \texttt{debug-mixin}.

\Defgeneric {merge-space} {client information value}

Given an instance of the class \texttt{information} and an
integer between $0$ and $3$, return a new instance that is just like
\textit{information} (including the class and the values of
all the slots), except that its space information has been updated
according to that of \textit{value}.

\Defmethod {merge-space}\\
           {client\\
            (information {\tt space-mixin})\\
            value}

This is the default method provided on \texttt{merge-space} and it is
specialized to \texttt{space-mixin}.

\Defgeneric {merge-safety} {client information value}

Given an instance of the class \texttt{information} and an
integer between $0$ and $3$, return a new instance that is just like
\textit{information} (including the class and the values of
all the slots), except that its safety information has been updated
according to that of \textit{value}.

\Defmethod {merge-safety}\\
           {client\\
            (information {\tt safety-mixin})\\
            value}

This is the default method provided on \texttt{merge-safety} and it is
specialized to \texttt{safety-mixin}.

\section{Adding and annotating variables}

\subsection{Adding a lexical variable}

{\footnotesize
\Defgeneric {add-lexical-variable} {client environment name \optional identity}
}

This function returns a new environment that is like
\textit{environment} except that it has been augumented with a lexical
variable named \textit{name}.  The optional argument \textit{identity}
can be supplied by client code to distinguish different lexical
variables with the same name.

\subsection{Adding a special variable}

{\footnotesize
\Defgeneric {add-special-variable} {client environment name}
}

This function returns a new environment that is like
\textit{environment} except that it has been augumented with a special
variable named \textit{name}.

\subsection{Annotating a variable with a type}
\label{sec-annotating-a-variable-with-a-type}

{\footnotesize
\Defgeneric {add-variable-type} {client environment name type}
}

This function returns a new environment that is like
\textit{environment} except that the variable named \textit{name} has
been annotated with the type specifier \textit{type}.

The type of the variable returned when the new environment is queried
for the variable named \textit{name} will have a new type that is the
conjunction of \textit{type} and the type it had in
\textit{environment}.

This function can be used when \textit{name} names a lexical variable,
a special variable, or a symbol macro
\seesec{sec-annotating-a-symbol-macro-with-a-type}, but \emph{not}
when \textit{name} names a constant variable.

\subsection{Annotating a variable with an \texttt{ignore} declaration}
\label{sec-annotating-a-variable-with-ignore}

{\footnotesize
\Defgeneric {add-variable-ignore} {client environment name ignore}
}

This function returns a new environment that is like
\textit{environment} except that the variable named \textit{name} has
been annotated with an \texttt{ignore} declaration.

The argument \textit{ignore} must be the symbol \texttt{ignore} or the
symbol \texttt{ignorable}.

This function can be used when \textit{name} names a lexical variable
or a local symbol macro
\seesec{sec-annotating-a-local-symbol-macro-with-ignore}.

\section{Adding and annotating symbol macros}

\subsection{Adding a local symbol macro}

{\footnotesize
\Defgeneric {add-local-symbol-macro} {client environment name expansion}
}

This function returns a new environment that is like
\textit{environment} except that it has been augmented with a local
symbol macro named \texttt{name}, with the expansion
\textit{expansion}

\subsection{Annotating a symbol macro with a type}
\label{sec-annotating-a-symbol-macro-with-a-type}

The generic function \texttt{add-variable-type}
\seesec{sec-annotating-a-variable-with-a-type} can be used to annotate
the type of a (local or global) symbol macro.

\subsection{Annotating a symbol macro with an \texttt{ignore} declaration}
\label{sec-annotating-a-local-symbol-macro-with-ignore}

The generic function \texttt{add-variable-ignore}
\seesec{sec-annotating-a-variable-with-ignore} can be used to annotate
a \emph{local} symbol macro with an \texttt{ignore} declaration.
Global symbol macros can not be annotated this way.

\section{Adding and annotating functions}

\subsection{Adding a local function}

{\footnotesize
\Defgeneric {add-local-function} {client environment name \optional identity}
}

This function returns a new environment that is like
\textit{environment} except that it has been augumented with a local
function named \textit{name}.  The optional argument \textit{identity}
can be supplied by client code to distinguish different functions with
the same name.

\section{Adding and annotating macros}

{\footnotesize
\Defgeneric {add-local-macro} {client environment name expander}
}

This function returns a new environment that is like
\textit{environment} except that it has been augmented with a local
macro named \texttt{name}.  The argument \textit{expander} is a
macro-expansion function that takes two arguments, a form and an
environment.

\section{Adding a block}

{\footnotesize
\Defgeneric {add-block} {client environment name \optional identity}
}

This function returns a new environment that is like
\textit{environment} except that it has been augumented with a block
named \textit{name}, which must be a symbol.  The optional argument
\textit{identity} can be supplied by client code to distinguish
different blocks with the same name.

\section{Adding a tag}

{\footnotesize
\Defgeneric {add-tag} {client environment tag \optional identity}
}

This function returns a new environment that is like
\textit{environment} except that it has been augumented with a tag
named \textit{tag}, which must be a \emph{go tag}, i.e. a symbol or an
integer.  The optional argument \textit{identity} can be supplied by
client code to distinguish different tags with the same name.
