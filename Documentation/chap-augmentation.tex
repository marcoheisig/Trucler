\chapter{Augmenting the environment}

\section{Creating new description}

In order to create a new description, \texttt{make-instance}
must be called, providing values for all the initialization arguments
corresponding to features that do not have any initialization forms.

\section{Low-level augmentation functions}

In this section, we describe basic functions for augmenting an
environment, given an old environment and a description.

{\footnotesize
\Defgeneric {augment-with-variable-description} {client environment description}
}

This function is used to create a new environment object from an
existing environment object and an instance of the class
\texttt{variable-description}.

{\footnotesize
\Defmethod {augment-with-variable-description}\\
           {client\\
            (environment {\tt environment})\\
            (description {\tt variable-description})}
}

This default method returns a new environment object which is like the
one passed as an argument, except that \textit{description}
will shadow any variable description with the same name.

{\footnotesize
\Defgeneric {augment-with-function-description} {client environment function-description}
}

This function is used to create a new environment object from an
existing environment object and an instance of the class
\texttt{function-description}.

{\footnotesize
\Defmethod {augment-with-function-description}\\
           {client\\
            (environment {\tt environment})\\
            (function-description {\tt function-description})}
}

This default method returns a new environment object which is like the
one passed as an argument, except that \textit{function-description}
will shadow any function description with the same name.

{\footnotesize
\Defgeneric {augment-with-block-description}
            {client environment block-description}
}

This function is used to create a new environment object from an
existing environment object and an instance of the class
\texttt{block-description}.

{\footnotesize
\Defmethod {augment-with-block-description}\\
           {client\\
            (environment {\tt environment})\\
            (block-description {\tt block-description})}
}

This default method returns a new environment object which is like the
one passed as an argument, except that \textit{block-description}
will shadow any block description with the same name.

{\footnotesize
\Defgeneric {augment-with-tag-description}
            {client environment tag-description}
}

This function is used to create a new environment object from an
existing environment object and an instance of the class
\texttt{tag-description}.

{\footnotesize
\Defmethod {augment-with-tag-description}\\
           {client\\
            (environment {\tt environment})\\
            (tag-description {\tt tag-description})}
}

This default method returns a new environment object which is like the
one passed as an argument, except that \textit{tag-description}
will shadow any tag description with the same name.

{\footnotesize
\Defgeneric {augment-with-optimize-description}\\
            {client environment optimize-description}
}

This function is used to create a new environment object from an
existing environment object and an instance of the class
\texttt{optimize-description}.

{\footnotesize
\Defmethod {augment-with-optimize-description}\\
           {client\\
            (environment {\tt environment})\\
            (optimize-description {\tt optimize-description})}
}

This default method returns a new environment object which is like the
one passed as an argument, except that \textit{optimize-description}
will shadow any previous optimize description.

\section{Merging descriptions}

We use the term \emph{merging} to mean the creation of a new
description from an existing description plus some
additional information such as type or dynamic extent.

In this section, we describe generic functions that are provided for
this purpose.

{\footnotesize
\Defgeneric {merge-type} {client description type}
}

Given an instance of the class \texttt{description} and a
type descriptor, return a new instance that is just like
\textit{description} (including the class and the values of
all the slots), except that its type description has been updated
according to that of \textit{type}.

{\footnotesize
\Defcondition {invalid-description-for-merging-type-information}
}

This condition is signaled by \texttt{merge-type} when the
\textit{description} argument is not an instance of a class that
contains information about type.

{\footnotesize
\Defmethod {merge-type} {client description type}
}

This is the default method provided on \texttt{merge-type}.  It
signals the condition
\texttt{invalid-description-for-merging-type-information}.

{\footnotesize
\Defmethod {merge-type}\\
           {client\\
            (description {\tt type-mixin})\\
            type}
}

This is the main method provided on \texttt{merge-type}
and it is specialized to \texttt{type-mixin}.

{\footnotesize
\Defgeneric {merge-ignore} {client description ignore}
}

Given an instance of the class \texttt{description} and one
of the symbols \texttt{cl:ignore} and \texttt{cl:ignorable},
return a new instance that is just like
\textit{description} (including the class and the values of
all the slots), except that its ignore information has been updated
according to that of \textit{ignore}.

{\footnotesize
\Defcondition {invalid-description-for-merging-ignore-information}
}

This condition is signaled by \texttt{merge-ignore} when the
\textit{description} argument is not an instance of a class that
contains information about ignore.

{\footnotesize
\Defmethod {merge-ignore} {client description ignore}
}

This is the default method provided on \texttt{merge-ignore}.  It
signals the condition
\texttt{invalid-description-for-merging-ignore-information}.

{\footnotesize
\Defmethod {merge-ignore}\\
           {client\\
            (description {\tt ignore-mixin})\\
            ignore}
}

This is the main method provided on \texttt{merge-ignore}
and it is specialized to \texttt{ignore-mixin}.

{\footnotesize
\Defgeneric {merge-dynamic-extent} {client description}
}

Given an instance of the class \texttt{description}, return a
new instance that is just like \textit{description}
(including the class and the values of all the slots), except that its
dynamic-extent information has been updated so that it is \emph{true}.

{\footnotesize
\Defcondition {invalid-description-for-merging-dynamic-extent-information}
}

This condition is signaled by \texttt{merge-dynamic-extent} when the
\textit{description} argument is not an instance of a class that
contains information about dynamic-extent.

{\footnotesize
\Defmethod {merge-dynamic-extent} {client description}
}

This is the default method provided on \texttt{merge-dynamic-extent}.  It
signals the condition
\texttt{invalid-description-for-merging-dynamic-extent-information}.

{\footnotesize
\Defmethod {merge-dynamic-extent} {client (description {\tt dynamic-extent-mixin})}
}

This is the main method provided on
\texttt{merge-dynamic-extent} and it is specialized to
\texttt{dynamic-extent-mixin}.

{\footnotesize
\Defgeneric {merge-inline} {client description inline}
}

Given an instance of the class \texttt{description} and one
of the symbols \texttt{cl:inline} and \texttt{cl:notinline},
return a new instance that is just like
\textit{description} (including the class and the values of
all the slots), except that its inline information has been updated
according to that of \textit{inline}.


{\footnotesize
\Defcondition {invalid-description-for-merging-inline-information}
}

This condition is signaled by \texttt{merge-inline} when the
\textit{description} argument is not an instance of a class that
contains information about inline.

{\footnotesize
\Defmethod {merge-inline} {client description inline}
}

This is the default method provided on \texttt{merge-inline}.  It
signals the condition
\texttt{invalid-description-for-merging-inline-information}.

{\footnotesize
\Defmethod {merge-inline}\\
           {client\\
            (description {\tt inline-mixin})\\
            inline}
}

This is the main method provided on \texttt{merge-inline}
and it is specialized to \texttt{inline-mixin}.

{\footnotesize
\Defgeneric {merge-speed} {client description value}
}

Given an instance of the class \texttt{description} and an
integer between $0$ and $3$, return a new instance that is just like
\textit{description} (including the class and the values of
all the slots), except that its speed information has been updated
according to that of \textit{value}.

{\footnotesize
\Defcondition {invalid-description-for-merging-speed-information}
}

This condition is signaled by \texttt{merge-speed} when the
\textit{description} argument is not an instance of a class that
contains information about speed.

{\footnotesize
\Defmethod {merge-speed} {client description speed}
}

This is the default method provided on \texttt{merge-speed}.  It
signals the condition
\texttt{invalid-description-for-merging-speed-information}.

{\footnotesize
\Defmethod {merge-speed}\\
           {client\\
            (description {\tt speed-mixin})\\
            value}
}

This is the main method provided on \texttt{merge-speed} and it is
specialized to \texttt{speed-mixin}.

{\footnotesize
\Defgeneric {merge-compilation-speed} {client description value}
}

Given an instance of the class \texttt{description} and an
integer between $0$ and $3$, return a new instance that is just like
\textit{description} (including the class and the values of
all the slots), except that its compilation-speed information has been
updated according to that of \textit{value}.

{\footnotesize
\Defcondition {invalid-description-for-merging-compilation-speed-information}
}

This condition is signaled by \texttt{merge-compilation-speed} when the
\textit{description} argument is not an instance of a class that
contains information about compilation-speed.

{\footnotesize
\Defmethod {merge-compilation-speed} {client description compilation-speed}
}

This is the default method provided on \texttt{merge-compilation-speed}.  It
signals the
\texttt{invalid-description-for-merging-compilation-speed-information}
condition.

{\footnotesize
\Defmethod {merge-compilation-speed}\\
           {client\\
            (description {\tt compilation-speed-mixin})\\
            value}
}

This is the main method provided on
\texttt{merge-compilation-speed} and it is specialized to
\texttt{compilation-speed-mixin}.

{\footnotesize
\Defgeneric {merge-debug} {client description value}
}

Given an instance of the class \texttt{description} and an
integer between $0$ and $3$, return a new instance that is just like
\textit{description} (including the class and the values of
all the slots), except that its debug information has been updated
according to that of \textit{value}.

{\footnotesize
\Defcondition {invalid-description-for-merging-debug-information}
}

This condition is signaled by \texttt{merge-debug} when the
\textit{description} argument is not an instance of a class that
contains information about debug.

{\footnotesize
\Defmethod {merge-debug} {client description debug}
}

This is the default method provided on \texttt{merge-debug}.  It
signals the condition
\texttt{invalid-description-for-merging-debug-information}.

{\footnotesize
\Defmethod {merge-debug}\\
           {client\\
            (description {\tt debug-mixin})\\
            value}
}

This is the main method provided on \texttt{merge-debug} and it is
specialized to \texttt{debug-mixin}.

{\footnotesize
\Defgeneric {merge-space} {client description value}
}

Given an instance of the class \texttt{description} and an
integer between $0$ and $3$, return a new instance that is just like
\textit{description} (including the class and the values of
all the slots), except that its space information has been updated
according to that of \textit{value}.

{\footnotesize
\Defcondition {invalid-description-for-merging-space-information}
}

This condition is signaled by \texttt{merge-space} when the
\textit{description} argument is not an instance of a class that
contains information about space.

{\footnotesize
\Defmethod {merge-space} {client description space}
}

This is the default method provided on \texttt{merge-space}.  It
signals the condition
\texttt{invalid-description-for-merging-space-information}.

{\footnotesize
\Defmethod {merge-space}\\
           {client\\
            (description {\tt space-mixin})\\
            value}
}

This is the main method provided on \texttt{merge-space} and it is
specialized to \texttt{space-mixin}.

{\footnotesize
\Defgeneric {merge-safety} {client description value}
}

Given an instance of the class \texttt{description} and an
integer between $0$ and $3$, return a new instance that is just like
\textit{description} (including the class and the values of
all the slots), except that its safety information has been updated
according to that of \textit{value}.

{\footnotesize
\Defcondition {invalid-description-for-merging-safety-information}
}

This condition is signaled by \texttt{merge-safety} when the
\textit{description} argument is not an instance of a class that
contains information about safety.

{\footnotesize
\Defmethod {merge-safety} {client description safety}
}

This is the default method provided on \texttt{merge-safety}.  It
signals the condition
\texttt{invalid-description-for-merging-safety-information}.

{\footnotesize
\Defmethod {merge-safety}\\
           {client\\
            (description {\tt safety-mixin})\\
            value}
}

This is the main method provided on \texttt{merge-safety} and it is
specialized to \texttt{safety-mixin}.

\section{High-level annotation functions}

\subsection{Adding and annotating variables}

\subsubsection{Adding a lexical variable}

{\footnotesize
\Defgeneric {add-lexical-variable} {client environment name \optional identity}
}

This function returns a new environment that is like
\textit{environment} except that it has been augumented with a lexical
variable named \textit{name}.  The optional argument \textit{identity}
can be supplied by client code to distinguish different lexical
variables with the same name.

{\footnotesize
\Defmethod{add-lexical-variable}
{client
 (environment environment)
 name
 \optional identity}
}

This is the main method on \texttt{add-lexical-variable}.  It
instantiates the class \texttt{lexical-variable-description} and then
creates a new environment by calling the function
\texttt{augment-with-variable-description}.

\subsubsection{Adding a special variable}

{\footnotesize
\Defgeneric {add-special-variable} {client environment name}
}

This function returns a new environment that is like
\textit{environment} except that it has been augumented with a special
variable named \textit{name}.

{\footnotesize
\Defmethod{add-special-variable}
{client
 (environment environment)
 name}
}

This is the main method on \texttt{add-special-variable}.  It
instantiates the class \texttt{special-variable-description} and then
creates a new environment by calling the function
\texttt{augment-with-variable-description}.


\subsubsection{Adding a local symbol macro}

{\footnotesize
\Defgeneric {add-local-symbol-macro} {client environment name expansion}
}

This function returns a new environment that is like
\textit{environment} except that it has been augmented with a local
symbol macro named \texttt{name}, with the expansion
\textit{expansion}

{\footnotesize
\Defmethod{add-local-symbol-macro}
{client
 (environment environment)
 name
 expansion}
}

This is the main method on \texttt{add-local-symbol-macro}.  It
instantiates the class \texttt{local-symbol-macro-description} and then
creates a new environment by calling the function
\texttt{augment-with-variable-description}.

\subsubsection{Annotating a variable with a type}
\label{sec-annotating-a-variable-with-a-type}

{\footnotesize
\Defgeneric {add-variable-type} {client environment name type}
}

This function returns a new environment that is like
\textit{environment} except that the variable named \textit{name} has
been annotated with the type specifier \textit{type}.

The type of the variable returned when the new environment is queried
for the variable named \textit{name} will have a new type that is the
conjunction of \textit{type} and the type it had in
\textit{environment}.

This function can be used when \textit{name} names a lexical variable,
a special variable, or a symbol macro, but \emph{not}
when \textit{name} names a constant variable.

{\footnotesize
\Defmethod{add-variable-type}
{client
 (environment environment)
 name
 type}
}

This is the main method on \texttt{add-variable-type}.  It
calls \texttt{describe-variable} to obtain an existing variable
description.  It then calls \texttt{merge-type} to create a new
variable description.  Finally, it calls
\texttt{augment-with-variable-description} in order to create and
return a new environment.

\subsubsection{Annotating a variable with an \texttt{ignore} declaration}
\label{sec-annotating-a-variable-with-ignore}

{\footnotesize
\Defgeneric {add-variable-ignore} {client environment name ignore}
}

This function returns a new environment that is like
\textit{environment} except that the variable named \textit{name} has
been annotated with an \texttt{ignore} declaration.

The argument \textit{ignore} must be the symbol \texttt{ignore} or the
symbol \texttt{ignorable}.

This function can be used when \textit{name} names a lexical variable
or a local symbol macro.

{\footnotesize
\Defmethod{add-variable-ignore}
{client
 (environment environment)
 name
 ignore}
}

This is the main method on \texttt{add-variable-ignore}.  It
calls \texttt{describe-variable} to obtain an existing variable
description.  It then calls \texttt{merge-ignore} to create a new
variable description.  Finally, it calls
\texttt{augment-with-variable-description} in order to create and
return a new environment.

\subsubsection{Annotating a variable with a \texttt{dynamic-extent} declaration}
\label{sec-annotating-a-variable-with-dynamic-extent}

{\footnotesize
\Defgeneric {add-variable-dynamic-extent} {client environment name}
}

This function returns a new environment that is like
\textit{environment} except that the variable named \textit{name} has
been annotated with an \texttt{dynamic-extent} declaration.

This function can be used only when \textit{name} names a lexical variable.

{\footnotesize
\Defmethod{add-variable-dynamic-extent}
{client
 (environment environment)
 name}
}

This is the main method on \texttt{add-variable-dynamic-extent}.  It
calls \texttt{describe-variable} to obtain an existing variable
description.  It then calls \texttt{merge-dynamic-extent} to create a new
variable description.  Finally, it calls
\texttt{augment-with-variable-description} in order to create and
return a new environment.

\subsection{Adding and annotating functions}

\subsubsection{Adding a local function}

{\footnotesize
\Defgeneric {add-local-function} {client environment name \optional identity}
}

This function returns a new environment that is like
\textit{environment} except that it has been augumented with a local
function named \textit{name}.  The optional argument \textit{identity}
can be supplied by client code to distinguish different functions with
the same name.

{\footnotesize
\Defmethod{add-local-function}
{client
 (environment environment)
 name
 \optional identity}
}

This is the main method on \texttt{add-local-function}.  It
instantiates the class \texttt{local-function-description} and then
creates a new environment by calling the function
\texttt{augment-with-function-description}.

\subsubsection{Adding a local macro}

{\footnotesize
\Defgeneric {add-local-macro} {client environment name expander}
}

This function returns a new environment that is like
\textit{environment} except that it has been augmented with a local
macro named \texttt{name}.  The argument \textit{expander} is a
macro-expansion function that takes two arguments, a form and an
environment.

{\footnotesize
\Defmethod {add-local-macro} {client (environment environment) name expander}
}

This is the main method on \texttt{add-local-macro}.  It instantiates
the class named \texttt{local-macro-description} and then creates a
new environment by calling the function
\texttt{augment-with-function-description}.

\subsubsection{Annotating a function with a type}
\label{sec-annotating-a-function-with-a-type}

{\footnotesize
\Defgeneric {add-function-type} {client environment name type}
}

This function returns a new environment that is like
\textit{environment} except that the function named \textit{name} has
been annotated with the type specifier \textit{type}.

The type of the function returned when the new environment is queried
for the function named \textit{name} will have a new type that is the
conjunction of \textit{type} and the type it had in
\textit{environment}.

This function can be used when \textit{name} names a local function or
a global function.

{\footnotesize
\Defmethod{add-function-type}
{client
 (environment environment)
 name
 type}
}

This is the main method on \texttt{add-function-type}.  It
calls \texttt{describe-function} to obtain an existing function
description.  It then calls \texttt{merge-type} to create a new
function description.  Finally, it calls
\texttt{augment-with-function-description} in order to create and
return a new environment.

\subsubsection{Annotating a function with an \texttt{ignore} declaration}
\label{sec-annotating-a-function-with-ignore}

{\footnotesize
\Defgeneric {add-function-ignore} {client environment name ignore}
}

This function returns a new environment that is like
\textit{environment} except that the function named \textit{name} has
been annotated with an \texttt{ignore} declaration.

The argument \textit{ignore} must be the symbol \texttt{ignore} or the
symbol \texttt{ignorable}.

This function can be used when \textit{name} names a local function or
a local macro.

{\footnotesize
\Defmethod{add-function-ignore}
{client
 (environment environment)
 name
 ignore}
}

This is the main method on \texttt{add-function-ignore}.  It calls
\texttt{describe-function} to obtain an existing function description.
It then calls \texttt{merge-ignore} to create a new function
description.  Finally, it calls
\texttt{augment-with-function-description} in order to create and
return a new environment.

\subsubsection{Annotating a function with a \texttt{dynamic-extent} declaration}
\label{sec-annotating-a-function-with-dynamic-extent}

{\footnotesize
\Defgeneric {add-function-dynamic-extent} {client environment name}
}

This function returns a new environment that is like
\textit{environment} except that the function named \textit{name} has
been annotated with an \texttt{dynamic-extent} declaration.

This function can be used only when \textit{name} names a local function.

{\footnotesize
\Defmethod{add-function-dynamic-extent}
{client
 (environment environment)
 name}
}

This is the main method on \texttt{add-function-dynamic-extent}.  It
calls \texttt{describe-function} to obtain an existing variable
description.  It then calls \texttt{merge-dynamic-extent} to create a new
variable description.  Finally, it calls
\texttt{augment-with-function-description} in order to create and
return a new environment.

\subsubsection{Annotating a function with an \texttt{inline} declaration}
\label{sec-annotating-a-function-with-inline}

{\footnotesize
\Defgeneric {add-inline} {client environment name inline}
}

This function returns a new environment that is like
\textit{environment} except that the function named \textit{name} has
been annotated with an \texttt{inline} declaration.

The argument \textit{inline} must be the symbol \texttt{inline} or the
symbol \texttt{notinline}.

This function can be used when \textit{name} names a local function or
a local macro.

{\footnotesize
\Defmethod{add-inline}
{client
 (environment environment)
 name
 inline}
}

This is the main method on \texttt{add-inline}.  It calls
\texttt{describe-function} to obtain an existing function description.
It then calls \texttt{merge-inline} to create a new function
description.  Finally, it calls
\texttt{augment-with-function-description} in order to create and
return a new environment.

\subsection{Adding blocks}

{\footnotesize
\Defgeneric {add-block} {client environment name \optional identity}
}

This function returns a new environment that is like
\textit{environment} except that it has been augumented with a block
named \textit{name}, which must be a symbol.  The optional argument
\textit{identity} can be supplied by client code to distinguish
different blocks with the same name.

{\footnotesize
\Defmethod{add-block}
{client
 (environment environment)
 name
 \optional identity}
}

This is the main method on \texttt{add-block}.  It instantiates the
class \texttt{block-description} and then creates a new
environment by calling the function
\texttt{augment-with-block-description}.

\subsection{Adding tags}

{\footnotesize
\Defgeneric {add-tag} {client environment tag \optional identity}
}

This function returns a new environment that is like
\textit{environment} except that it has been augumented with a tag
named \textit{tag}, which must be a \emph{go tag}, i.e. a symbol or an
integer.  The optional argument \textit{identity} can be supplied by
client code to distinguish different tags with the same name.

{\footnotesize
\Defmethod{add-tag}
{client
 (environment environment)
 tag
 \optional identity}
}

This is the main method on \texttt{add-tag}.  It instantiates the
class \texttt{tag-description} and then creates a new
environment by calling the function
\texttt{augment-with-tag-description}.

\subsection{Annotating the \texttt{optimize} qualities}

\def\Optimizefunction #1 {This function returns a new environment that
  is like \textit{environment} except that the \texttt{optimize}
  information has been updated with a \texttt{#1} quality value.

The argument \textit{value} must be an integer between $0$ and $3$.}


\def\Optimizemethod #1 {This is the main method on
  \texttt{add-#1}.  It calls \texttt{describe-optimize} to obtain
  the existing optimize description.  It then calls
  \texttt{merge-#1} to create a new optimize description.  Finally,
  it calls \texttt{augment-with-optimize-description} in order to
  create and return a new environment.}

\subsubsection{Annotating \texttt{optimize} with a \texttt{speed} value}
\label{sec-annotating-optimize-with-speed}

{\footnotesize
\Defgeneric {add-speed} {client environment value}
}

\Optimizefunction{speed}

{\footnotesize
\Defmethod{add-speed}
{client
 (environment environment)
  value}
}

\Optimizemethod{speed}

\subsubsection{Annotating \texttt{optimize} with a \texttt{compilation-speed} value}

{\footnotesize
\Defgeneric {add-compilation-speed} {client environment value}
}

\Optimizefunction{compilation-speed}

{\footnotesize
\Defmethod{add-compilation-speed}
{client
 (environment environment)
  value}
}

\Optimizemethod{compilation-speed}

\subsubsection{Annotating \texttt{optimize} with a \texttt{debug} value}

{\footnotesize
\Defgeneric {add-debug} {client environment value}
}

\Optimizefunction{debug}

{\footnotesize
\Defmethod{add-debug}
{client
 (environment environment)
  value}
}

\Optimizemethod{debug}

\subsubsection{Annotating \texttt{optimize} with a \texttt{safety} value}

{\footnotesize
\Defgeneric {add-safety} {client environment value}
}

\Optimizefunction{safety}

{\footnotesize
\Defmethod{add-safety}
{client
 (environment environment)
  value}
}

\Optimizemethod{safety}

\subsubsection{Annotating \texttt{optimize} with a \texttt{space} value}

{\footnotesize
\Defgeneric {add-space} {client environment value}
}

\Optimizefunction{space}

{\footnotesize
\Defmethod{add-space}
{client
 (environment environment)
  value}
}

\Optimizemethod{space}
